<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ hostname }} - VLC Control</title>
    <style>
        body {
            background-color: #000;
            color: #777;
        }
        #output {
            white-space: pre-wrap; /* Maintains whitespace formatting. */
            background: #111;
            padding: 10px;
            border: 1px solid #ddd;
            margin-top: 20px;
            height: 300px;
            overflow-y: auto;
        }
        button {
            cursor: pointer;
            padding: 10px 20px;
            margin-top: 10px;
            background-color: #4C50AF;
            color: white; 
            border: none;
            border-radius: 5px;
            font-weight: bold;
        }
        #windowTitle {
          font-weight: bold;
          /*font-size: 1.5em;*/
        }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
          fetchVolume();

          document.getElementById("start").addEventListener("click", function() {
            fetch('/vlc/start').then(response => response.json()).then(data => alert(data.status));
          });

          document.getElementById("stop").addEventListener("click", function() {
            fetch('/vlc/stop').then(response => response.json()).then(data => alert(data.status));
          });

          document.getElementById("volup").addEventListener("click", function() {
            fetch('/alsa/volup').then(response => response.json()).then(data => {
              //alert(data.status);
              fetchVolume();  // Update volume display after change
            });
          });

          document.getElementById("voldown").addEventListener("click", function() {
            fetch('/alsa/voldown').then(response => response.json()).then(data => {
              //alert(data.status);
              fetchVolume();  // Update volume display after change
            });
          });

          document.getElementById("bton").addEventListener("click", function() {
            fetch('/bt/on').then(response => response.json()).then(data => {
            });
          });

          document.getElementById("btoff").addEventListener("click", function() {
            fetch('/bt/off').then(response => response.json()).then(data => {
            });
          });
          document.getElementById("shutdown").addEventListener('click', ()=>{
            const token = 'SHUTDOWN';
            if(!confirm('Shutdown the system?')){
              return;
            }
            fetch(`/system/shutdown`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: new URLSearchParams({
                'token': token
              })
            })
            .then(response => response.json())
            .then(data => {
              if (data.error) {
                alert(`Error: ${data.error}`);
              } else {
                alert(data.status);
              }
            })
            .catch(error => console.error('Error:', error));
          });

          document.getElementById("reboot").addEventListener('click', ()=>{
            const token = 'REBOOT';
            if(!confirm('Reboot the system?')){
              return;
            }
            fetch(`/system/reboot`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: new URLSearchParams({
                'token': token
              })
            })
            .then(response => response.json())
            .then(data => {
              if (data.error) {
                alert(`Error: ${data.error}`);
              } else {
                alert(data.status);
              }
            })
            .catch(error => console.error('Error:', error));
          });

        });

        function fetchVolume() {
            fetch('/alsa/vol').then(response => response.json())
            .then(data => {
                if (data.volume) {
                    document.getElementById("currentVolume").innerText = 'Current Volume: ' + data.volume;
                } else {
                    alert(data.error);
                }
            });
        }

        let isScanning = false;
        let eventSource;

        function updateButton() {
            const btn = document.getElementById('scanBtn');
            if (isScanning) {
                btn.textContent = 'Stop Scan';
            } else {
                btn.textContent = 'Start Scan';
            }
        }

        function handleScanData(event) {
            const outputDiv = document.getElementById('output');
            // Append new lines of output
            outputDiv.innerHTML += event.data;
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        function startScan() {
            // Start the scan and handle the stream
            eventSource = new EventSource("/bt/scan");
            eventSource.onmessage = handleScanData;
            eventSource.onerror = function() {
                stopScan(); // Stop scan on error
            };
            isScanning = true;
            updateButton();
        }

        function stopScan() {
            if (eventSource) {
                eventSource.close();
            }
            isScanning = false;
            updateButton();
        }

        function toggleScan() {
            if (isScanning) {
                stopScan();
            } else {
                startScan();
            }
        }

        function fetchLoadAverages() {
          fetch('/system/lavg')
            .then(response => response.json())
            .then(data => {
              document.getElementById('loadAverages').innerHTML =
                '[' + data['1_min'].toFixed(2) + ', ' +
                data['5_min'].toFixed(2) + ', ' +
                data['15_min'].toFixed(2) + ']';
              })
            .catch(error => {
              console.error('Error fetching load averages:', error);
              document.getElementById('loadAverages').innerHTML = 'Failed to load data.';
              });
        }

        setInterval(fetchLoadAverages, 10000);

        fetchLoadAverages();

        const updateTitle = async () => {
          const resp = await fetch('/window-title');
          const title = await resp.json();
          document.querySelector('#windowTitle').innerText = `${title}`;
        };
        updateTitle();
        setInterval(updateTitle, 30000);

    </script>
</head>
<body>
    <h1>{{ hostname }} - VLC Control</h1>
    <div id="systemInfo">
      <div id="windowTitle"></div>
      <div id="loadAverages"></div>
      <div id="currentVolume">Current Volume: Loading...</div>
    </div>
    <div>
        <button id="start">Start VLC</button>
        <button id="stop">Stop VLC</button>
    </div>
    <div>
        <button id="volup">Volume Up</button>
        <button id="voldown">Volume Down</button>
    </div>
    <br>
    <div>
        <button id="bton">Bluetooth On</button>
        <button id="scanBtn" onclick="toggleScan()">Start Scan</button>
        <button id="btoff">Bluetooth Off</button>
    <div id="output"></div>
    <div>
        <button id="shutdown">Shutdown</button>
        <button id="reboot">Reboot</button>
    </div>
</body>
</html>
